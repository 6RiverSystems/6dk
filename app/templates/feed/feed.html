{% extends "base.html" %}

{% block app_content %}
<div class="center-align">
	<div class="chip center-align">{{ messages|length }}</div> messages found across
	<div class="chip center-align">all profiles</div> between
	<div class="chip center-align">the start of time</div> and
	<div class="chip center-align">the end of time</div>
	<a class="btn-floating blue darken-4 waves-effect modal-trigger tooltipped" data-position="bottom" data-tooltip="Search Messages" href="#filterModal" >
	    <i class="material-icons">search</i>
	</a>
  <a class="btn-floating blue darken-4 waves-effect modal-trigger tooltipped" data-position="bottom" data-tooltip="E-Mail Results" href="#" >
      <i class="material-icons">email</i>
  </a>
	<a class="btn-floating blue darken-4 waves-effect modal-trigger tooltipped" data-position="bottom" data-tooltip="Clear Filters" href="#" >
	    <i class="material-icons">clear</i>
	</a>
</div>
</br>
<div class="divider"></div>
</br>
{% for message in messages %}
<div class="card-panel hoverable">
	<div class="row">
		<div class="col s6">
			<div class="chip center-align">
				{{ message.message_type }}
			</div>
		</div>
		<div class="col s6 right-align">
			<small class="tooltipped" data-position="top" data-tooltip="{{ message.updated.isoformat() }}Z">{{ moment( message.updated ).format('lll') }}</small><small class="tooltipped" data-position="top" data-tooltip="{{ message.token_id }}"> via {{ message.profile.data.friendly_name }}</small>
		</div>
	</div>
	<div class="divider"></div>
	<div class="right-align">
        {% if message.message_type in valid_northbound %}
        <a class="waves-effect waves-blue btn-flat tooltipped" data-position="top" data-tooltip="Replay Message" href="javascript:get_message('{{ message.id }}', 'replay');">
            <i class="material-icons">replay</i>
        </a>
        {% endif %}
        <a class="waves-effect waves-blue btn-flat tooltipped" data-position="top" data-tooltip="View Data" href="javascript:get_message('{{ message.id }}', 'data');">
            <i class="material-icons">code</i>
        </a>
    </div>
    <div id="message-panel-{{ message.id }}"></div>
</div>
{% endfor %}

<div id="filterModal" class="modal top-sheet">
  <div class="modal-content">
    <h5 class="center-align">Search Message Feed</h5>
  <div class="row">
    <form class="col s12" id="filterForm" name="filterForm" action="#" method="get">
      <div class="row">
        <div class="col s6">message type</div>
         <div class="col s6">profile</div>
      </div>
      <div class="row">
        <div class="col s6">transmitted after</div>
         <div class="col s6">transmitted before</div>
      </div>
      <div class="row">
        <div class="col s12">query string</div>
      </div>
      <div class="row">
        <div class="input-field col s12">
          <p class="center-align">
            <button class="waves-effect waves-light btn-floating blue darken-4 z-depth-3" type="submit" name="action">
              <i class="material-icons right">search</i>
            </button>
          </p>
        </div>
      </div>

    </form>
  </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-blue btn-flat">Dismiss</a>
  </div>
</div>

{{ moment.include_jquery() }}
{{ moment.include_moment() }}

<script>
  function get_message(message_id, task) {
      $('#message-panel-'+message_id).html('<div class="progress"><div class="indeterminate blue darken-4"></div></div>');
      $.post('/feed/message/'+message_id+'/'+task, {
          message_id: message_id,
      }).done(function(response) {
          $('#message-panel-'+message_id).html(response['html'])
      }).fail(function() {
          $('#message-panel-'+message_id).html("<p>{{ (' Error: Lookup failed.') }}</p>");
      });
  }
</script>

<script>
  function replay_message(message_id, token_id) {
      $('#message-'+message_id).html('<small>6dk replay</small></br><div class="progress"><div class="indeterminate blue darken-4"></div></div>');
      $.post('/wms/replay/'+message_id+'/'+token_id, {
          message_id: message_id,
      }).done(function(response) {
          $('#message-'+message_id).text(response['html']);
          $('#transmission-info-'+message_id).html(response['replay_text']);
      }).fail(function() {
          $('#message-'+message_id).html("<p>{{ (' Error: Replay failed.') }}</p>");
      });
  }
</script>

<script>
  function copy_text(element) {
    var $temp = $("<input>");
    $("body").append($temp);
    $temp.val($(element).text()).select();
    document.execCommand("copy");
    $temp.remove();
  }
</script>

<script>
function download_text(ref, filename) {
    var text = $(ref).text()
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

</script>

{% endblock %}